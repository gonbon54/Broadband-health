<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Digital Health Divide — Broadband Access & Health Outcomes in America's Counties</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #FAFAF7;
  --surface: #FFFFFF;
  --text-primary: #1A1A1A;
  --text-secondary: #555555;
  --text-muted: #888888;
  --accent: #1B6B5A;
  --accent-light: #E8F4F0;
  --urban: #2B7A78;
  --suburban: #E8985E;
  --rural: #C44536;
  --border: #E8E6E1;
  --divider: #D4D0C8;
  --highlight: #FFF3CD;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Source Sans 3', 'Source Sans Pro', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  font-size: 17px;
  line-height: 1.68;
  -webkit-font-smoothing: antialiased;
}

h1, h2, h3 { font-family: 'DM Serif Display', Georgia, serif; font-weight: 400; }

.container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }

/* ---- HERO ---- */
.hero {
  padding: 80px 0 60px;
  border-bottom: 1px solid var(--divider);
}
.hero .overline {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 16px;
}
.hero h1 {
  font-size: clamp(32px, 5vw, 54px);
  line-height: 1.15;
  color: var(--text-primary);
  margin-bottom: 20px;
  max-width: 800px;
}
.hero .subtitle {
  font-size: 20px;
  color: var(--text-secondary);
  max-width: 700px;
  line-height: 1.6;
  font-weight: 300;
}

/* ---- KEY FINDINGS ---- */
.findings {
  padding: 48px 0;
  border-bottom: 1px solid var(--divider);
}
.findings h2 { font-size: 28px; margin-bottom: 24px; }
.findings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}
.finding-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  position: relative;
}
.finding-card .number {
  font-family: 'DM Serif Display', serif;
  font-size: 36px;
  color: var(--accent);
  line-height: 1.1;
  margin-bottom: 8px;
}
.finding-card p {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* ---- SECTIONS ---- */
.viz-section {
  padding: 60px 0;
  border-bottom: 1px solid var(--divider);
}
.viz-section h2 {
  font-size: 30px;
  margin-bottom: 8px;
}
.viz-section .section-subtitle {
  font-size: 17px;
  color: var(--text-secondary);
  margin-bottom: 28px;
  font-weight: 300;
}
.viz-section .interpretation {
  margin-top: 24px;
  max-width: 800px;
}
.viz-section .interpretation p {
  margin-bottom: 14px;
  color: var(--text-secondary);
}
.viz-section .interpretation strong {
  color: var(--text-primary);
  font-weight: 600;
}

/* ---- CHART CONTAINERS ---- */
.chart-wrapper {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 28px 24px 16px;
  overflow: hidden;
}
.chart-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 18px;
  align-items: center;
}
.chart-controls label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.chart-controls select,
.chart-controls button {
  font-family: inherit;
  font-size: 14px;
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text-primary);
  cursor: pointer;
  transition: border-color 0.2s;
}
.chart-controls select:hover,
.chart-controls button:hover {
  border-color: var(--accent);
}
.chart-controls button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.legend {
  display: flex;
  gap: 20px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
}
.legend-swatch {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

/* ---- SVG STYLES ---- */
svg text { font-family: 'Source Sans 3', sans-serif; }
.axis text { font-size: 12px; fill: var(--text-muted); }
.axis line, .axis path { stroke: var(--border); }
.axis-label { font-size: 13px; font-weight: 600; fill: var(--text-secondary); }
.grid line { stroke: var(--border); stroke-opacity: 0.5; stroke-dasharray: 2,3; }
.grid .domain { display: none; }

.tooltip {
  position: fixed;
  pointer-events: none;
  background: rgba(26,26,26,0.92);
  color: #fff;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 13px;
  line-height: 1.45;
  max-width: 260px;
  z-index: 1000;
  backdrop-filter: blur(4px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  opacity: 0;
  transition: opacity 0.15s;
}
.tooltip.visible { opacity: 1; }
.tooltip .tt-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.tooltip .tt-row { display: flex; justify-content: space-between; gap: 12px; }
.tooltip .tt-label { color: #aaa; }
.tooltip .tt-value { font-weight: 600; }

/* ---- METHOD / LIMITATIONS / FOOTER ---- */
.text-section {
  padding: 48px 0;
  border-bottom: 1px solid var(--divider);
}
.text-section h2 { font-size: 26px; margin-bottom: 16px; }
.text-section p { max-width: 760px; color: var(--text-secondary); margin-bottom: 12px; }

.footer {
  padding: 40px 0;
  font-size: 14px;
  color: var(--text-muted);
}
.footer a { color: var(--accent); text-decoration: none; }
.footer p { margin-bottom: 6px; }

/* ---- RESPONSIVE ---- */
@media (max-width: 768px) {
  .hero { padding: 48px 0 36px; }
  .viz-section { padding: 40px 0; }
  .chart-wrapper { padding: 16px 12px 12px; }
  .findings-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
  .findings-grid { grid-template-columns: 1fr; }
}

/* Map color legend */
.map-legend-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 8px;
}
.map-legend-gradient {
  width: 200px;
  height: 12px;
  border-radius: 3px;
}

/* Scatter brush hint */
.brush-hint {
  font-size: 12px;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 6px;
}

/* Loading */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
  font-size: 16px;
}
</style>
</head>
<body>

<div class="tooltip" id="tooltip"></div>

<!-- ===== HERO ===== -->
<section class="hero">
<div class="container">
  <div class="overline">County Health Rankings 2025 · Data Brief</div>
  <h1>The Digital Health Divide</h1>
  <p class="subtitle">Does broadband internet access correlate with health outcomes in rural versus urban counties? An analysis of over 3,000 U.S. counties to visualize broadband internet access and health outcomes.</p>
</div>
</section>

<!-- ===== KEY FINDINGS ===== -->
<section class="findings">
<div class="container">
  <h2>Key Findings</h2>
  <div class="findings-grid">
    <div class="finding-card">
      <div class="number">11.1 pp</div>
      <p>Rural counties with less than 70% broadband access report 26.8% poor or fair health, compared to 15.7% in rural counties above 90% a 11.1 percentage-point gap.</p>
    </div>
    <div class="finding-card">
      <div class="number">72%</div>
      <p>Among the 250 counties with the worst health outcomes, 72% of them also fall in the bottom quartile for broadband access, revealing geographic discrepancies.</p>
    </div>
    <div class="finding-card">
      <div class="number">6.7M</div>
      <p>Roughly 6.7 million Americans live in rural counties that lack both adequate broadband (less than 80%) and primary care physicians (ratio less than 2000 to 1), exposing a critical telehealth gap.</p>
    </div>
    <div class="finding-card">
      <div class="number">5.1 yrs</div>
      <p>Life expectancy averages 77.7 years in the highest quartile of broadband access, versus 72.6 years in the lowest quartile, a gap of more than 5 years.</p>
    </div>
  </div>
</div>
</section>

<!-- ===== VISUALIZATION 1: SCATTER PLOT ===== -->
<section class="viz-section" id="scatter-section">
<div class="container">
  <h2>Broadband Access and Self-Reported Health</h2>
  <p class="section-subtitle">Each circle represents a U.S. county; color indicates community type classification</p>
  <div class="chart-wrapper">
    <div class="chart-controls">
      <label>Filter by rurality:</label>
      <button class="rurality-btn active" data-filter="all">All</button>
      <button class="rurality-btn" data-filter="Urban">Urban</button>
      <button class="rurality-btn" data-filter="Suburban">Suburban</button>
      <button class="rurality-btn" data-filter="Rural">Rural</button>
      <span style="margin-left:auto;"></span>
      <label>State:</label>
      <select id="state-filter"><option value="all">All States</option></select>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--urban)"></div> Urban (&lt;20% rural)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--suburban)"></div> Suburban (20–50%)</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--rural)"></div> Rural (&gt;50%)</div>
    </div>
    <div id="scatter-chart"></div>
    <div class="brush-hint">Hover over any dot for details. Use the filter buttons or state dropdown to explore subsets.</div>
  </div>
  <div class="interpretation">
    <p><strong>The relationship between broadband access and self-reported health is strikingly consistent across all three rurality categories.</strong> In rural counties with less than 70% broadband penetration, an average of 26.8% of adults report poor or fair health, nearly double the 15.7% in rural counties with broadband penetration exceeding 90%. The same pattern holds in suburban and urban settings, though rural counties cluster disproportionately at the lower end of both broadband access and health status.</p>
    <p>The correlation between broadband and poor reported health is strong and negative across all groups, indicating that broadband access is a factor in health. However, the correlation becomes weaker in rural areas, suggesting that variables unique to different communities also contribute to health outcomes. The trends indicate that <strong>broadband access is a factor in health outcomes</strong> and that healthcare availability must be conjoined with connectivity.</p>
  </div>
</div>
</section>

<!-- ===== VISUALIZATION 2: MAP ===== -->
<section class="viz-section" id="map-section">
<div class="container">
  <h2>Mapping the Digital Health Divide</h2>
  <p class="section-subtitle">County-level geographic patterns across the contiguous United States</p>
  <div class="chart-wrapper">
    <div class="chart-controls">
      <label>Show:</label>
      <button class="map-var-btn active" data-var="broadband">Broadband Access %</button>
      <button class="map-var-btn" data-var="health">Poor or Fair Health %</button>
      <button class="map-var-btn" data-var="lifeexp">Life Expectancy (years)</button>
    </div>
    <div id="map-chart"></div>
    <div id="map-legend-container"></div>
  </div>
  <div class="interpretation">
    <p><strong>On the map, you can see a clear "digital health divide" across the rural South, parts of the Great Plains, and the Southwest.</strong> These are the areas that show the darkest on the broadband and health maps. Try switching between the two maps using the filters above the map to see just how closely the patterns line up with eachother.</p>
    <p>Three areas that stand out are the southern Mississippi River, eastern Kentucky, and the southern border of Texas. All three of these areas exhibit low broadband access and adverse health outcomes. On the contrary, metropolitan areas in the Northeast and parts of the upper Midwest show high activity and good health outcomes. This connection underscores the need to invest in county-level broadband infrastructure, focusing on areas with underdeveloped broadband and poor health outcomes.</p>
  </div>
</div>
</section>

<!-- ===== VISUALIZATION 3: GROUPED BAR CHART ===== -->
<section class="viz-section" id="bar-section">
<div class="container">
  <h2>Health Outcomes Across Broadband Quartiles</h2>
  <p class="section-subtitle">Average health indicators grouped by broadband access level and community types</p>
  <div class="chart-wrapper">
    <div class="chart-controls">
      <label>Metric:</label>
      <button class="bar-metric-btn active" data-metric="health">Poor/Fair Health %</button>
      <button class="bar-metric-btn" data-metric="mental">Frequent Mental Distress %</button>
      <button class="bar-metric-btn" data-metric="diabetes">Diabetes Prevalence %</button>
      <button class="bar-metric-btn" data-metric="lifeexp">Life Expectancy (yrs)</button>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--urban)"></div> Urban</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--suburban)"></div> Suburban</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--rural)"></div> Rural</div>
    </div>
    <div id="bar-chart"></div>
  </div>
  <div class="interpretation">
    <p><strong>Across all health metrics examined, counties in the lowest broadband quartile (bottom 25%) are worse than those in the highest quartile (top 25%).</strong> For example, here are some of the numbers: the average rate of poor or fair health in the bottom quarter of broadband connectivity is 23.7% versus 16.2% in the top quarter, a 7.5 percentage-point difference. These findings are consistent with academic research linking broadband access to health information and telemedicine.</p>
    <p>Use the metric toggle to compare patterns for mental distress, diabetes, and life expectancy. The consistency of the broadband–health gradient across multiple outcomes strengthens the case that digital connectivity functions as a <strong>social determinant of health</strong> alongside other determinants such as poverty, education, and genetics. These findings suggest that federal broadband initiatives such as the Broadband Equity, Access, and Deployment program (a 2021 federal broadband infrastructure program) may yield measurable public health returns.</p>
  </div>
</div>
</section>

<!-- ===== METHODOLOGY ===== -->
<section class="text-section">
<div class="container">
  <h2>Methodology</h2>
  <p>This analysis was based on data from the <strong>Health Rankings &amp; Roadmaps 2025</strong> dataset, created by the University of Wisconsin Population Health Institute. The data is extensive, covering 3,143 counties across all 50 states and D.C. The primary variable in this study, broadband access, is measured as the percent of households with a broadband internet subscription. The University of Wisconsin derives Self-reported health, mental distress, and diabetes prevalence from the CDC's Behavioral Risk Factor Surveillance System. The counties were categorized as urban, suburban, or rural by using the Census's categorization. Lastly, counties missing any of the aforementioned variables were excluded from the analysis, leaving 3,119 counties.</p>
</div>
</section>

<!-- ===== LIMITATIONS ===== -->
<section class="text-section">
<div class="container">
  <h2>Limitations</h2>
  <p><strong>Correlation, not causation.</strong> The patterns shown in this analysis do not indicate that broadband access is the sole contributor to health outcomes. Counties with limited access to broadband internet tend to be less affluent, more remote, and older; each of these factors could affect health outcomes. It is possible that broadband may be a marker of broader economic outcomes rather than a direct cause of better health.</p>
  <p><strong>Measurement constraints.</strong> As mentioned in the Methodology section, Broadband access reflects subscription rates; it is not a measure of internet quality. So a household may technically have broadband internet, but may lack the speed and quality for telehealth video visits. Lastly, Self-reported health is a survey question and is highly subjective. This may reflect personal discrepancies in how people describe their well-being.</p>
</div>
</section>

<!-- ===== FOOTER ===== -->
<footer class="footer">
<div class="container">
  <p><strong>Data Source:</strong> University of Wisconsin Population Health Institute. County Health Rankings &amp; Roadmaps 2025. <a href="https://www.countyhealthrankings.org" target="_blank">countyhealthrankings.org</a>. Accessed 2025.</p>
  <p><strong>Technical Credits:</strong> Visualizations built with <a href="https://d3js.org/" target="_blank">D3.js v7</a> and <a href="https://github.com/topojson/us-atlas" target="_blank">US Atlas TopoJSON</a>.</p>
</div>
</footer>

<!-- ===== SCRIPTS ===== -->
<script>
// ==========================================
// GLOBALS & UTILITY
// ==========================================
const COLORS = { Urban: '#2B7A78', Suburban: '#E8985E', Rural: '#C44536' };
const tooltip = d3.select('#tooltip');

function showTooltip(evt, html) {
  tooltip.html(html).classed('visible', true);
  const tt = tooltip.node();
  let x = evt.clientX + 14, y = evt.clientY - 10;
  if (x + tt.offsetWidth > window.innerWidth - 10) x = evt.clientX - tt.offsetWidth - 14;
  if (y + tt.offsetHeight > window.innerHeight - 10) y = evt.clientY - tt.offsetHeight - 10;
  if (y < 5) y = 5;
  tooltip.style('left', x + 'px').style('top', y + 'px');
}
function hideTooltip() { tooltip.classed('visible', false); }

function pct(v) { return v != null ? (v * 100).toFixed(1) + '%' : 'N/A'; }
function num(v, d=1) { return v != null ? (+v).toFixed(d) : 'N/A'; }

function rurality(ruralPct) {
  if (ruralPct < 0.20) return 'Urban';
  if (ruralPct < 0.50) return 'Suburban';
  return 'Rural';
}

// ==========================================
// LOAD DATA
// ==========================================
d3.csv('analytic_data2025_v3.csv').then(raw => {
  // Skip row index 1 (variable codes row) and national aggregate
  // D3 csv already uses row 0 as headers, so raw[0] is the variable-codes row
  const counties = raw.slice(1).filter(d => {
    const fips = d['5-digit FIPS Code'];
    return fips && !fips.endsWith('000');
  }).map(d => {
    const bb = +d['Broadband Access raw value'] || null;
    const ruralVal = +d['% Rural raw value'];
    const health = +d['Poor or Fair Health raw value'] || null;
    const lifeExp = +d['Life Expectancy raw value'] || null;
    const mental = +d['Frequent Mental Distress raw value'] || null;
    const diabetes = +d['Diabetes Prevalence raw value'] || null;
    const pop = +d['Population raw value'] || null;
    const pcpRatio = +d['Ratio of population to primary care physicians.'] || null;
    const mhpRatio = +d['Ratio of population to mental health providers.'] || null;
    const income = +d['Median Household Income raw value'] || null;
    return {
      fips: d['5-digit FIPS Code'],
      state: d['State Abbreviation'],
      name: d['Name'],
      broadband: bb,
      ruralPct: isNaN(ruralVal) ? null : ruralVal,
      rurality: isNaN(ruralVal) ? null : rurality(ruralVal),
      health, lifeExp, mental, diabetes, pop, pcpRatio, mhpRatio, income
    };
  }).filter(d => d.broadband != null && d.ruralPct != null);

  // Populate state dropdown
  const states = [...new Set(counties.map(d => d.state))].sort();
  const stateSelect = d3.select('#state-filter');
  states.forEach(s => stateSelect.append('option').attr('value', s).text(s));

  // Build visualizations
  buildScatter(counties);
  buildMap(counties);
  buildBarChart(counties);
}).catch(err => {
  console.error('Error loading data:', err);
  document.getElementById('scatter-chart').innerHTML = '<div class="loading">Error loading data. Ensure analytic_data2025_v3.csv is in the same directory.</div>';
});

// ==========================================
// VIZ 1: SCATTER PLOT
// ==========================================
function buildScatter(data) {
  const container = d3.select('#scatter-chart');
  const fullW = container.node().getBoundingClientRect().width;
  const margin = {top: 20, right: 30, bottom: 54, left: 62};
  const width = fullW - margin.left - margin.right;
  const height = Math.min(480, width * 0.6);

  const svg = container.append('svg')
    .attr('width', fullW)
    .attr('height', height + margin.top + margin.bottom);
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  const validData = data.filter(d => d.health != null);

  const x = d3.scaleLinear().domain([0.45, 1.0]).range([0, width]).clamp(true);
  const y = d3.scaleLinear().domain([0, 0.45]).range([height, 0]).clamp(true);
  const r = d3.scaleSqrt().domain([0, d3.max(validData, d => d.pop)]).range([2, 18]);

  // Grid
  g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-width).tickFormat(''));
  g.append('g').attr('class','grid').attr('transform',`translate(0,${height})`).call(d3.axisBottom(x).tickSize(-height).tickFormat(''));

  // Axes
  g.append('g').attr('class','axis').attr('transform',`translate(0,${height})`)
    .call(d3.axisBottom(x).ticks(8).tickFormat(d => (d*100)+'%'));
  g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(6).tickFormat(d => {
    const rounded = Math.round(d * 100);
    return rounded + '%';
  }));

  // Axis labels
  g.append('text').attr('class','axis-label').attr('text-anchor','middle')
    .attr('x', width/2).attr('y', height + 44).text('Broadband Access (% of households)');
  g.append('text').attr('class','axis-label').attr('text-anchor','middle')
    .attr('transform', `translate(${-46},${height/2})rotate(-90)`).text('Adults Reporting Poor or Fair Health (%)');

  // Trend lines per rurality
  const trendGroup = g.append('g').attr('class','trends');
  function drawTrends(filteredData) {
    trendGroup.selectAll('*').remove();
    ['Urban','Suburban','Rural'].forEach(cat => {
      const sub = filteredData.filter(d => d.rurality === cat && d.health && d.broadband);
      if (sub.length < 10) return;
      const xm = d3.mean(sub, d=>d.broadband), ym = d3.mean(sub, d=>d.health);
      const num = d3.sum(sub, d => (d.broadband-xm)*(d.health-ym));
      const den = d3.sum(sub, d => (d.broadband-xm)**2);
      if (den === 0) return;
      const slope = num/den, intercept = ym - slope*xm;
      const xRange = d3.extent(sub, d=>d.broadband);
      trendGroup.append('line')
        .attr('x1', x(xRange[0])).attr('y1', y(intercept + slope*xRange[0]))
        .attr('x2', x(xRange[1])).attr('y2', y(intercept + slope*xRange[1]))
        .attr('stroke', COLORS[cat]).attr('stroke-width', 2.5)
        .attr('stroke-dasharray', '6,4').attr('opacity', 0.7);
    });
  }

  // Dots
  const dots = g.selectAll('.dot')
    .data(validData)
    .join('circle')
    .attr('class', 'dot')
    .attr('cx', d => x(d.broadband))
    .attr('cy', d => y(d.health))
    .attr('r', d => r(d.pop || 10000))
    .attr('fill', d => COLORS[d.rurality])
    .attr('fill-opacity', 0.45)
    .attr('stroke', d => COLORS[d.rurality])
    .attr('stroke-width', 0.5)
    .attr('stroke-opacity', 0.6)
    .on('mouseenter', function(evt, d) {
      d3.select(this).attr('fill-opacity', 0.9).attr('stroke-width', 2);
      showTooltip(evt, `<div class="tt-title">${d.name}, ${d.state}</div>
        <div class="tt-row"><span class="tt-label">Broadband</span><span class="tt-value">${pct(d.broadband)}</span></div>
        <div class="tt-row"><span class="tt-label">Poor/Fair Health</span><span class="tt-value">${pct(d.health)}</span></div>
        <div class="tt-row"><span class="tt-label">Population</span><span class="tt-value">${d.pop ? d.pop.toLocaleString() : 'N/A'}</span></div>
        <div class="tt-row"><span class="tt-label">Classification</span><span class="tt-value">${d.rurality}</span></div>`);
    })
    .on('mousemove', function(evt) {
      const tt = tooltip.node();
      let lx = evt.clientX + 14, ly = evt.clientY - 10;
      if (lx + tt.offsetWidth > window.innerWidth - 10) lx = evt.clientX - tt.offsetWidth - 14;
      tooltip.style('left', lx+'px').style('top', ly+'px');
    })
    .on('mouseleave', function() {
      d3.select(this).attr('fill-opacity', 0.45).attr('stroke-width', 0.5);
      hideTooltip();
    });

  drawTrends(validData);

  // Filters
  let activeRurality = 'all';
  let activeState = 'all';

  function applyFilters() {
    const filtered = validData.filter(d => {
      if (activeRurality !== 'all' && d.rurality !== activeRurality) return false;
      if (activeState !== 'all' && d.state !== activeState) return false;
      return true;
    });
    dots.transition().duration(400)
      .attr('fill-opacity', d => {
        const match = (activeRurality === 'all' || d.rurality === activeRurality) &&
                      (activeState === 'all' || d.state === activeState);
        return match ? 0.5 : 0.04;
      })
      .attr('stroke-opacity', d => {
        const match = (activeRurality === 'all' || d.rurality === activeRurality) &&
                      (activeState === 'all' || d.state === activeState);
        return match ? 0.6 : 0.04;
      });
    drawTrends(filtered);
  }

  d3.selectAll('.rurality-btn').on('click', function() {
    d3.selectAll('.rurality-btn').classed('active', false);
    d3.select(this).classed('active', true);
    activeRurality = this.dataset.filter;
    applyFilters();
  });

  d3.select('#state-filter').on('change', function() {
    activeState = this.value;
    applyFilters();
  });
}

// ==========================================
// VIZ 2: CHOROPLETH MAP
// ==========================================
function buildMap(data) {
  const container = d3.select('#map-chart');
  const fullW = container.node().getBoundingClientRect().width;
  const height = Math.min(560, fullW * 0.62);

  const svg = container.append('svg')
    .attr('width', fullW)
    .attr('height', height)
    .attr('viewBox', `0 0 975 610`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const dataMap = new Map();
  data.forEach(d => dataMap.set(d.fips, d));

  const colorScales = {
    broadband: d3.scaleSequential(d3.interpolateGnBu).domain([0.50, 1.0]),
    health: d3.scaleSequential(d3.interpolateYlOrRd).domain([0.08, 0.35]),
    lifeexp: d3.scaleSequential(d3.interpolateRdYlGn).domain([65, 85])
  };

  const legendLabels = {
    broadband: { title: 'Broadband Access', low: '50%', high: '100%' },
    health: { title: 'Poor or Fair Health', low: '8%', high: '35%' },
    lifeexp: { title: 'Life Expectancy', low: '65 yrs', high: '85 yrs' }
  };

  let currentVar = 'broadband';

  function getVal(d, varName) {
    if (varName === 'broadband') return d.broadband;
    if (varName === 'health') return d.health;
    if (varName === 'lifeexp') return d.lifeExp;
    return null;
  }

  function fmtVal(d, varName) {
    if (varName === 'broadband') return pct(d.broadband);
    if (varName === 'health') return pct(d.health);
    if (varName === 'lifeexp') return num(d.lifeExp, 1) + ' years';
    return 'N/A';
  }

  // Legend
  function updateLegend() {
    const lc = d3.select('#map-legend-container');
    lc.html('');
    const info = legendLabels[currentVar];
    const scale = colorScales[currentVar];
    const div = lc.append('div').attr('class','map-legend-bar');
    div.append('span').text(info.low);
    const canvas = document.createElement('canvas');
    canvas.width = 200; canvas.height = 12;
    const ctx = canvas.getContext('2d');
    for (let i = 0; i < 200; i++) {
      ctx.fillStyle = scale(scale.domain()[0] + (scale.domain()[1]-scale.domain()[0]) * i / 199);
      ctx.fillRect(i, 0, 1, 12);
    }
    const img = div.append('img').attr('src', canvas.toDataURL()).attr('class','map-legend-gradient')
      .style('width','200px').style('height','12px').style('border-radius','3px');
    div.append('span').text(info.high);
    div.append('span').style('margin-left','12px').style('font-weight','600').style('color','#555').text(info.title);
  }

  // Load US topology
  d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-albers-10m.json').then(us => {
    const path = d3.geoPath();
    const countyFeatures = topojson.feature(us, us.objects.counties).features;
    const stateFeatures = topojson.mesh(us, us.objects.states, (a, b) => a !== b);

    svg.append('g').selectAll('path')
      .data(countyFeatures)
      .join('path')
      .attr('class', 'county-path')
      .attr('d', path)
      .attr('fill', d => {
        const cd = dataMap.get(d.id);
        if (!cd) return '#e8e6e1';
        const v = getVal(cd, currentVar);
        return v != null ? colorScales[currentVar](v) : '#e8e6e1';
      })
      .attr('stroke', '#fff')
      .attr('stroke-width', 0.2)
      .on('mouseenter', function(evt, d) {
        d3.select(this).attr('stroke', '#333').attr('stroke-width', 1.5).raise();
        const cd = dataMap.get(d.id);
        if (cd) {
          showTooltip(evt, `<div class="tt-title">${cd.name}, ${cd.state}</div>
            <div class="tt-row"><span class="tt-label">Broadband</span><span class="tt-value">${pct(cd.broadband)}</span></div>
            <div class="tt-row"><span class="tt-label">Poor/Fair Health</span><span class="tt-value">${pct(cd.health)}</span></div>
            <div class="tt-row"><span class="tt-label">Life Expectancy</span><span class="tt-value">${cd.lifeExp ? num(cd.lifeExp,1)+' yrs' : 'N/A'}</span></div>
            <div class="tt-row"><span class="tt-label">Classification</span><span class="tt-value">${cd.rurality || 'N/A'}</span></div>`);
        }
      })
      .on('mousemove', function(evt) {
        const tt = tooltip.node();
        let lx = evt.clientX + 14, ly = evt.clientY - 10;
        if (lx + tt.offsetWidth > window.innerWidth - 10) lx = evt.clientX - tt.offsetWidth - 14;
        tooltip.style('left', lx+'px').style('top', ly+'px');
      })
      .on('mouseleave', function() {
        d3.select(this).attr('stroke', '#fff').attr('stroke-width', 0.2);
        hideTooltip();
      });

    svg.append('path')
      .datum(stateFeatures)
      .attr('fill', 'none')
      .attr('stroke', '#aaa')
      .attr('stroke-width', 0.8)
      .attr('d', path);

    updateLegend();

    // Map variable toggle
    d3.selectAll('.map-var-btn').on('click', function() {
      d3.selectAll('.map-var-btn').classed('active', false);
      d3.select(this).classed('active', true);
      currentVar = this.dataset.var;
      svg.selectAll('.county-path')
        .transition().duration(500)
        .attr('fill', d => {
          const cd = dataMap.get(d.id);
          if (!cd) return '#e8e6e1';
          const v = getVal(cd, currentVar);
          return v != null ? colorScales[currentVar](v) : '#e8e6e1';
        });
      updateLegend();
    });
  }).catch(err => {
    console.error('Error loading map topology:', err);
    container.html('<div class="loading">Map requires internet to load county boundaries. Please open this file in a browser with network access.</div>');
  });
}

// ==========================================
// VIZ 3: GROUPED BAR CHART
// ==========================================
function buildBarChart(data) {
  const container = d3.select('#bar-chart');
  const fullW = container.node().getBoundingClientRect().width;
  const margin = {top: 20, right: 20, bottom: 64, left: 60};
  const width = fullW - margin.left - margin.right;
  const height = Math.min(400, width * 0.5);

  const svg = container.append('svg')
    .attr('width', fullW)
    .attr('height', height + margin.top + margin.bottom);
  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  // Compute quartiles
  const bbValues = data.filter(d => d.broadband).map(d => d.broadband).sort((a,b)=>a-b);
  const q25 = d3.quantile(bbValues, 0.25);
  const q50 = d3.quantile(bbValues, 0.50);
  const q75 = d3.quantile(bbValues, 0.75);

  function quartile(bb) {
    if (bb < q25) return 'Q1 (Lowest)';
    if (bb < q50) return 'Q2';
    if (bb < q75) return 'Q3';
    return 'Q4 (Highest)';
  }

  const quartiles = ['Q1 (Lowest)', 'Q2', 'Q3', 'Q4 (Highest)'];
  const ruralCats = ['Urban', 'Suburban', 'Rural'];

  function computeBarData(metricKey) {
    const accessor = {
      health: d => d.health,
      mental: d => d.mental,
      diabetes: d => d.diabetes,
      lifeexp: d => d.lifeExp
    }[metricKey];

    const results = [];
    quartiles.forEach(q => {
      ruralCats.forEach(rc => {
        const sub = data.filter(d => quartile(d.broadband) === q && d.rurality === rc && accessor(d) != null);
        const vals = sub.map(d => accessor(d));
        const mean = vals.length > 0 ? d3.mean(vals) : null;
        const display = metricKey === 'lifeexp' ? mean : (mean != null ? mean * 100 : null);
        results.push({ quartile: q, rurality: rc, value: display, n: vals.length });
      });
    });
    return results;
  }

  const labels = {
    health: { title: 'Adults Reporting Poor or Fair Health (%)', fmt: d => d.toFixed(1)+'%' },
    mental: { title: 'Adults with Frequent Mental Distress (%)', fmt: d => d.toFixed(1)+'%' },
    diabetes: { title: 'Adults with Diabetes (%)', fmt: d => d.toFixed(1)+'%' },
    lifeexp: { title: 'Average Life Expectancy (years)', fmt: d => d.toFixed(1) }
  };

  let currentMetric = 'health';

  // Scales
  const x0 = d3.scaleBand().domain(quartiles).range([0, width]).paddingInner(0.25).paddingOuter(0.1);
  const x1 = d3.scaleBand().domain(ruralCats).range([0, x0.bandwidth()]).padding(0.08);
  const y = d3.scaleLinear().range([height, 0]);

  // Axes
  const xAxis = g.append('g').attr('class','axis').attr('transform', `translate(0,${height})`);
  const yAxis = g.append('g').attr('class','axis');
  const yLabel = g.append('text').attr('class','axis-label').attr('text-anchor','middle')
    .attr('transform', `translate(${-44},${height/2})rotate(-90)`);

  // Quartile label
  g.append('text').attr('class','axis-label').attr('text-anchor','middle')
    .attr('x', width/2).attr('y', height + 52).text('Broadband Access Quartile');

  function update(metric) {
    currentMetric = metric;
    const barData = computeBarData(metric);
    const maxVal = d3.max(barData, d => d.value) || 1;
    const minVal = metric === 'lifeexp' ? Math.floor(d3.min(barData.filter(d=>d.value), d => d.value) - 2) : 0;
    y.domain([minVal, maxVal * 1.12]);

    xAxis.transition().duration(400).call(d3.axisBottom(x0));
    yAxis.transition().duration(400).call(d3.axisLeft(y).ticks(6).tickFormat(d => metric === 'lifeexp' ? d : d + '%'));
    yLabel.text(labels[metric].title);

    const bars = g.selectAll('.bar-group').data(barData, d => d.quartile + d.rurality);

    const enter = bars.enter().append('rect').attr('class','bar-group')
      .attr('x', d => x0(d.quartile) + x1(d.rurality))
      .attr('width', x1.bandwidth())
      .attr('y', height)
      .attr('height', 0)
      .attr('rx', 3)
      .attr('fill', d => COLORS[d.rurality])
      .attr('fill-opacity', 0.82)
      .on('mouseenter', function(evt, d) {
        d3.select(this).attr('fill-opacity', 1);
        showTooltip(evt, `<div class="tt-title">${d.quartile} · ${d.rurality}</div>
          <div class="tt-row"><span class="tt-label">${labels[currentMetric].title.split('(')[0].trim()}</span><span class="tt-value">${d.value != null ? labels[currentMetric].fmt(d.value) : 'N/A'}</span></div>
          <div class="tt-row"><span class="tt-label">Counties</span><span class="tt-value">${d.n}</span></div>`);
      })
      .on('mousemove', function(evt) {
        const tt = tooltip.node();
        let lx = evt.clientX + 14, ly = evt.clientY - 10;
        if (lx + tt.offsetWidth > window.innerWidth - 10) lx = evt.clientX - tt.offsetWidth - 14;
        tooltip.style('left', lx+'px').style('top', ly+'px');
      })
      .on('mouseleave', function() {
        d3.select(this).attr('fill-opacity', 0.82);
        hideTooltip();
      });

    enter.merge(bars).transition().duration(500)
      .attr('x', d => x0(d.quartile) + x1(d.rurality))
      .attr('width', x1.bandwidth())
      .attr('y', d => d.value != null ? y(d.value) : height)
      .attr('height', d => d.value != null ? height - y(d.value) : 0)
      .attr('fill', d => COLORS[d.rurality]);

    bars.exit().transition().duration(300).attr('height', 0).attr('y', height).remove();
  }

  update('health');

  d3.selectAll('.bar-metric-btn').on('click', function() {
    d3.selectAll('.bar-metric-btn').classed('active', false);
    d3.select(this).classed('active', true);
    update(this.dataset.metric);
  });
}
</script>
</body>
</html>
